## C++虚函数表

1. C++中每个对象**所占用的存储空间只是该对象的数据部分（虚函数指针和虚基类指针也属于数据部分）所占用的存储空间，而不包括函数代码所占用的存储空间**。

2. C++程序的内存格局通常分为四个区：**全局数据区(data area)，代码区(code area)，栈区(stack area)，堆区(heap area)(即自由存储区)**。全局数据区存放全局变量，静态数据和常量；所有**类成员函数和非成员函数代码存放在代码区**；为运行函数而分配的局部变量、函数参数、返回数据、返回地址等存放在栈区；余下的空间都被称为堆区。根据这个解释，我们可以得知在类的定义时，类成员函数是被放在代码区，而类的静态成员变量在类定义时就已经在全局数据区分配了内存，因而它是属于类的。对于非静态成员变量，我们是在类的实例化过程中(构造对象)才在栈区或者堆区为其分配内存，是为每个对象生成一个拷贝，所以它是属于对象的。

3. **静态成员函数和非静态成员函数都是在类的定义时放在内存的代码区**的，因而可以说它们都是属于类的，但是类为什么只能直接调用静态类成员函数，而非静态类成员函数(即使函数没有参数)只有类对象才能调用呢？原因是**类的非静态类成员函数其实都内含了一个指向类对象的指针型参数(即this指针)，因而只有类对象才能调用(此时this指针有实值)**。

4. 编译器处理虚函数的方法是：为每个类对象添加一个隐藏成员，隐藏成员中保存了一个指向函数地址数组的指针，称为虚表指针（vptr），这种数组成为虚函数表（virtual function table, vtbl），即，**每个类使用一个虚函数表，每个类对象用一个虚表指针**。

5. 基类对象包含一个虚表指针，指向基类中所有虚函数的地址表。派生类对象也将包含一个虚表指针，指向派生类虚函数表。

6. 如果派生类重写了基类的虚方法，该派生类虚函数表将保存重写的虚函数的地址，而不是基类的虚函数地址。

   如果基类中的虚方法没有在派生类中重写，那么派生类将继承基类中的虚方法，而且派生类中虚函数表将保存基类中未被重写的虚函数的地址。注意，如果派生类中定义了新的虚方法，则该虚函数的地址也将被添加到派生类虚函数表中。

7. 每一个含有虚函数（无论是其本身的，还是继承而来的）的类都至少有一个与之对应的虚函数表，其中存放着该类所有的虚函数对应的函数指针。派生类重写基类虚函数就会更新虚函数表中的虚表指针为派生类重写的虚函数的地址，而虚函数替换过程发生在编译时。

8. 无论基类指针pb指向哪种类型的对象，只要能够确定被调函数在虚函数中的偏移值，待运行时，能够确定具体类型，并能找到相应vptr了，就能找出真正应该调用的函数。

9. 当一个类继承多个类，且多个基类都有虚函数时，子类对象中将包含多个虚函数表的指针（即多个vptr）。当派生类D自身的虚函数与B基类共用了同一个虚函数表，因此也称B为D的主基类（primary base class）。

10. ###单继承（父类含虚函数）：
  子类与父类拥有各自的一个虚函数表
  若子类并无overwrite父类虚函数，用父类虚函数
  若子类重写（overwrite）了父类的虚函数，则子类虚函数将覆盖虚表中对应的父类虚函数
  若子声明了自己新的虚函数，则该虚函数地址将扩充到虚函数表最后

11. ### 一般多继承
   若子类新增虚函数，放在声明的第一个父类的虚函数表中
   若子类重写了父类的虚函数，所有父类的被overwrite的虚函数表都要改变
   内存布局中，父类按照其声明顺序排列

12. ### 简单虚继承
   虚继承的子类，如果本身定义了新的虚函数，则编译器为其生成一个新的虚函数指针（vptr）以及一张虚函数表。该vptr位于对象内存最前面（对比非虚继承：直接扩展父类虚函数表）
   虚继承的子类也单独保留了父类的vprt与虚函数表
   虚继承的子类有虚基类表指针（vbptr）
   在Microsoft Visual C++中，虚基类表指针总是在虚函数表指针之后，因而，对某个类实例来说，如果它有虚基类指针，那么虚基类指针可能在实例的0字节偏移处（该类没有vptr时，vbptr就处于类实例内存布局的最前面，否则vptr处于类实例内存布局的最前面），也可能在类实例的4字节偏移处。
   虚基类表也由多个条目组成，条目中存放的是偏移值。
   第一个条目存放虚基类表指针（vbptr）所在地址到该类内存首地址的偏移值
   第二、第三...个条目依次为该类的最左虚继承父类、次左虚继承父类...的内存地址相对于虚基类表指针的偏移值。

13. ### 菱形虚继承
   菱形虚继承是多继承和虚继承的复合。

   ![img](https://images2015.cnblogs.com/blog/461913/201608/461913-20160811112118199-124586448.png)

   ![img](https://images2015.cnblogs.com/blog/461913/201608/461913-20160811113004996-448222589.png)
